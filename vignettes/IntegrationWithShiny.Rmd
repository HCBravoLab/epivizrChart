---
title: "Visualizing genomic data in Shiny Apps using epivizrChart"
author: "Jayaram Kancherla, Hector Corrada Bravo"
date: "`r Sys.Date()`"
output:
  BiocStyle::html_document
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Visualizing genomic data in Shiny Apps using epivizrChart}
  %\usepackage[UTF-8]{inputenc}
---
  
In this vignette, we will build a shiny app to visualize genomic data using epivizrChart. Since epivizrChart package uses the web components framework, it can be integrated with most frameworks that support HTML. 

```{r setup, eval=TRUE, include=FALSE}
library(epivizrChart)
library(shiny)
library(Homo.sapiens)
```

Sample data sets to use for the vignette.

```{r}
data(tcga_colon_blocks)
data(tcga_colon_curves)
data(sumexp)
```

First we will create an epiviz Navigation component to render a visualization in the following genomic region. We will set `interactive=TRUE` so that the components can communicate with the shiny server to get data for the plots. We will then plot the data objects we loaded earlier. 

```{r}
epivizNav <- epivizNav(chr="chr11", start=118000000, end=121000000, interactive=TRUE)
genes_track <- epivizNav$add_genome(Homo.sapiens)
blocks_track <- epivizNav$plot(tcga_colon_blocks, datasource_name="450kMeth")
means_track <- epivizNav$plot(tcga_colon_curves, datasource_name="450kMeth", type="bp", columns=c("cancerMean","normalMean"))
region_scatterplot <- epivizNav$plot(sumexp, datasource_name="sumExp", columns=c("normal", "cancer"))
```

A Simple shiny app would be to render the visualization components. For this we will create a container on the io that will contain the epiviz components. On the server function, we will then call the render function on the navigation component to generate the HTML. We will also include `shiny=TRUE` and call the `register_shiny_handler` function to observe for events so that the components can communicate back and forth with the R-session.

```{r}
app <- shinyApp(
  ui=fluidPage(
    uiOutput("epivizChart")
  ),
  server=function(input, output, session) {
    
    output$epivizChart <- renderUI({
      epivizNav$render_component(shiny=TRUE)
    })
    
    # register for shiny events to manage data requests from UI
    epivizNav$register_shiny_handler(session)
  }
)

app

```

In this example. we will include an additional genomic region text box and as we update the text box, this will re render the epiviz components for the new location.

```{r}
app <- shinyApp(
  ui=fluidPage(
    textInput('gene_loc', 'Enter Genomic Location (example: chr11:118000000 - 121000000', "chr11:118000000-121000000"),
    uiOutput("epivizChart")
  ),
  server=function(input, output, session) {
    
    renderEpiviz <- function() {
      output$epivizChart <- renderUI({
        epivizNav$render_component(shiny=TRUE)
      })
    }
    
    observeEvent(input$gene_loc, {
      loc <- input$gene_loc
      if(loc != "") {
        chr_split <- strsplit(loc, ":")
        chr <- chr_split[[1]][1]
        range_split <- strsplit(chr_split[[1]][2], "-")
        
        epivizNav$navigate(chr = chr, 
                           start = strtoi(range_split[[1]][1]), 
                           end = strtoi(range_split[[1]][2]))
      }
      renderEpiviz()
    })
    
    epivizNav$register_shiny_handler(session)
  }
)

app

```